name: Tenable Cloud Security Full Scan
on:
  push:
    branches: [ main ]
  pull_request:
 
env:
  TENABLE_ACCESS_KEY: ${{ secrets.TENABLE_SECRETKEY }}
  TENABLE_SECRET_KEY: ${{ secrets.TENABLE_ACCESSKEY }}
 
jobs:
  tenable-full-scan:
    name: Run Tenable Cloud Security Scan
    runs-on: ubuntu-latest
 
    steps:
      # 1️⃣ Checkout del código
      - name: Checkout repository
        uses: actions/checkout@v4
 
      # 2️⃣ Instalar Tenable CLI (consec) - para contenedores e IaC
      - name: Install Tenable CLI (consec)
        run: |
          curl -sSL https://downloads.tenable.com/cloud-security/consec/install.sh | bash
          consec version
 
      # 3️⃣ Escaneo de IaC con Tenable (Accurics)
      - name: IaC Scan (Terraform / CloudFormation / K8s)
        uses: accurics/terrascan-action@v2
        with:
          fail_on_violation: true           # Falla el job si hay violaciones
          minimum_severity: HIGH            # Bloquea si hay hallazgos High o superiores
        env:
          TENABLE_ACCESS_KEY: ${{ secrets.TENABLE_SECRETKEY }}
          TENABLE_SECRET_KEY: ${{ secrets.TENABLE_ACCESSKEY }}
 
      # 4️⃣ Construir imagen Docker (opcional)
      - name: Build Docker image
        run: |
          docker build -t myapp:${{ github.sha }} .
 
      # 5️⃣ Escanear imagen con Tenable Container Security
      - name: Container Image Scan
        run: |
          ./consec image-scan myapp:${{ github.sha }} \
            --pipeline-type GITHUB \
            --pipeline-name "${{ github.repository }}-${{ github.sha }}" \
            --fail-on-severity CRITICAL
        env:
          TENABLE_ACCESS_KEY: ${{ secrets.TENABLE_SECRETKEY }}
          TENABLE_SECRET_KEY: ${{ secrets.TENABLE_ACCESSKEY }}
 
      # 6️⃣ (Opcional) Web App Scan si tienes uno configurado en Tenable WAS
      # Descomenta este bloque si usas Tenable Web App Scanning
      # - name: Web App Scan (Tenable WAS)
      #   uses: tenable/was-action@v2
      #   with:
      #     scan_name: "NombreDelScanEnTenable"
      #     folder_name: "Default"
      #     wait_for_results: true
      #   env:
      #     ACCESS_KEY: ${{ secrets.TENABLE_ACCESS_KEY }}
      #     SECRET_KEY: ${{ secrets.TENABLE_SECRET_KEY }}
 
      # 7️⃣ Subir reportes como artifacts
      - name: Upload Tenable reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tenable-reports-${{ github.run_id }}
          path: |
            ./accurics-reports/*
            ./consec_reports/*
